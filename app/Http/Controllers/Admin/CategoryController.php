<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Category;
use Illuminate\Http\Request;
use App\DataTables\CategoriesDataTable;
use Str;

class CategoryController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index(CategoriesDataTable $dataTable)
    {
        // foreach (Category::get() as $category) $category->update_tree();
        $data = json_decode('{"3":58,"16":58,"18":39,"20":61,"21":16,"23":46,"24":25,"25":25,"26":25,"27":25,"28":25,"29":25,"30":25,"31":25,"32":25,"33":25,"34":25,"35":25,"36":25,"38":58,"39":33,"40":35,"41":30,"44":18,"45":40,"46":61,"51":56,"52":56,"56":30,"57":62,"58":29,"59":56,"60":56,"61":56,"62":56,"63":56,"64":56,"65":56,"66":56,"67":56,"68":56,"69":56,"70":56,"71":56,"72":56,"73":30,"76":56,"77":25,"78":16,"79":39,"81":29,"82":29,"83":29,"84":29,"85":29,"86":29,"87":29,"88":29,"89":29,"90":29,"91":29,"92":29,"93":29,"94":29,"95":29,"96":58,"97":29,"98":29,"99":29,"100":29,"101":29,"102":26,"103":30,"104":54,"105":16,"106":31,"108":30,"113":56,"114":56,"115":56,"116":16,"119":30,"120":57,"121":61,"122":29,"123":67,"124":40,"126":39,"127":33,"128":33,"129":33,"130":33,"132":33,"134":33,"135":31,"136":33,"138":33,"139":33,"140":16,"141":26,"142":34,"146":55,"147":33,"152":35,"153":31,"154":33,"155":31,"156":31,"157":31,"159":33,"160":33,"161":33,"162":34,"163":33,"164":67,"165":67,"166":67,"167":16,"168":16,"169":16,"170":16,"171":16,"172":40,"173":16,"174":40,"178":16,"179":45,"182":39,"184":30,"191":22,"192":22,"194":39,"196":20,"198":61,"200":33,"201":33,"204":39,"205":39,"206":37,"207":54,"208":16,"212":33,"213":33,"214":33,"219":33,"224":33,"228":16,"229":33,"230":16,"232":40,"233":16,"234":40,"235":16,"236":20,"237":16,"238":16,"239":16,"240":16,"241":33,"242":16,"243":40,"245":16,"246":20,"247":49,"248":22,"249":39,"250":40,"251":33,"252":34,"255":33,"257":58,"259":34,"260":58,"261":61,"262":37,"263":40,"264":34,"265":16,"266":16,"267":16,"268":16,"269":33,"270":16,"271":16,"272":33,"273":16,"274":16,"275":16,"276":16,"277":16,"278":33,"279":20,"280":16,"281":16,"282":16,"283":16,"284":16,"285":16,"286":16,"287":16,"288":16,"289":16,"290":16,"291":16,"292":16,"293":16,"294":16,"295":16,"296":16,"297":16,"300":31,"301":33,"302":58,"303":18,"304":33,"305":53,"306":42,"307":40,"308":31,"309":33,"310":16,"311":33,"312":39,"313":33,"314":16,"315":16,"316":16,"317":16,"318":33,"319":16,"320":16,"321":16,"322":22,"323":33,"324":33,"327":61,"329":33,"330":34,"331":33,"332":40,"333":16,"334":33,"335":28,"337":42,"338":49,"339":33,"341":34,"342":39,"343":33,"344":30,"345":33,"346":37,"347":34,"348":40,"349":34,"351":33,"352":30,"353":30,"354":30,"355":16,"356":33,"357":33,"358":33,"359":29,"360":38,"361":28,"363":16,"364":16,"365":16,"366":16,"367":16,"368":16,"369":34,"370":33,"371":16,"372":49,"373":37,"378":16,"379":40,"381":22,"384":33,"385":16,"386":42,"387":30,"388":33,"390":33,"392":16,"393":67,"394":33,"395":16,"396":16,"397":16,"398":16,"399":16,"400":16,"401":16,"402":16,"403":16,"404":33,"405":16,"406":33,"407":16,"408":16,"409":16,"410":16,"411":16,"412":16,"413":16,"414":16,"415":16,"416":16,"417":16,"418":16,"419":16,"420":34,"421":16,"422":34,"423":45,"425":16,"426":40,"427":39,"428":16,"429":33,"430":33,"431":58,"432":67,"433":67,"434":33,"435":33,"436":39,"437":16,"438":39,"439":33,"441":16,"442":39,"443":28,"445":33,"447":16,"448":39,"449":16,"450":16,"451":16,"452":16,"453":34,"454":33,"459":39,"460":61,"461":25,"462":34,"463":34,"464":49,"465":34,"466":16,"468":33,"469":33,"470":33,"471":33,"473":33,"474":29,"475":25,"476":29,"477":31,"478":40,"479":33,"480":34,"481":33,"482":33,"483":34,"484":61,"486":39,"487":37,"488":36,"489":33,"490":61,"491":61,"508":58,"509":34,"511":34,"512":33,"513":31,"514":33,"515":31,"516":31,"517":36,"518":33,"519":31,"520":33,"521":33,"522":33,"523":33,"524":33,"525":39,"526":39,"527":39,"528":34,"529":16,"530":16,"531":16,"532":33,"533":29,"534":33,"535":33,"536":35,"537":16,"538":16,"539":16,"540":16,"541":16,"542":16,"543":16,"544":16,"545":16,"546":16,"547":16,"548":16,"549":16,"550":19,"551":16,"552":16,"553":16,"554":16,"555":16,"556":16,"557":16,"558":16,"559":16,"560":16,"561":16,"562":16,"563":33,"564":33,"565":33,"566":33,"567":33,"568":33,"569":33,"570":33,"571":33,"572":33,"573":33,"574":33,"575":33,"576":33,"577":33,"578":33,"579":33,"580":33,"581":33,"583":37,"585":33,"586":40,"587":16,"588":16,"589":16,"590":16,"591":16,"592":16,"593":16,"594":16,"595":16,"596":16,"597":16,"598":16,"599":16,"600":16,"601":16,"602":16,"603":16,"604":16,"605":16,"606":16,"607":16,"608":16,"609":16,"610":16,"611":16,"612":16,"613":16,"614":16,"615":16,"616":16,"617":16,"618":16,"619":16,"620":16,"623":39,"624":33,"625":39,"627":16,"628":33,"629":34,"630":34,"631":49,"632":33,"633":33,"634":33,"635":33,"636":33,"637":33,"638":39,"639":26,"640":34,"644":33,"645":33,"646":16,"647":20,"648":20,"649":16,"650":38,"651":16,"652":38,"653":16,"654":34,"655":16,"657":16,"658":33,"659":33,"660":34,"661":26,"663":31,"664":31,"665":20,"666":33,"667":31,"674":34,"675":34,"676":34,"677":34,"678":16,"679":16,"680":37,"681":39,"682":22,"683":16,"684":16,"685":40,"686":37,"687":39,"688":34,"689":33,"690":58,"691":58,"694":34,"696":18,"697":18,"698":18,"699":18,"700":49,"703":54,"705":54,"706":50,"707":34,"708":50,"709":33,"710":50,"711":50,"712":50,"713":61,"714":33,"715":39,"716":16,"718":36,"719":29,"721":16,"724":33,"727":33,"728":33,"730":33,"731":34,"732":56,"733":56,"734":56,"735":56,"736":56,"737":56,"738":40,"739":37,"740":38,"741":39,"743":33,"744":33,"745":33,"746":33,"747":56,"748":34,"749":16,"750":34}');
        foreach($data as $listing_id => $category_id){
            $listing = \App\Models\Listing::find($listing_id);
            $category = Category::find($category_id);
            if($listing && $category){
                $listing->sub_category_id = $category->id;
                $listing->save();
            }
        }
        return $dataTable->render('admin.categories.categories');
    }


    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {
        $request->validate([
            'name' => 'required|min:2|max:255',
            'category' => 'nullable|exists:categories,id',
            'image' => 'image|max:8192',
            'icon' => 'required|min:3',
        ]);

        $category = new Category;
        $category->name = $request->name;
        $slug = Str::slug($request->name);
        $category->slug = Category::where('slug', $slug)->count() ? $slug.'-'.uniqid() : $slug;
        $category->icon = $request->icon;
        $category->category_id = $request->category ? $request->category : null;

        if($category->save()){
            $category->upload_category_image($request->file('image'));
            $category->update_tree();
            return response()->json('تم الحفظ بنجاح!', 200);
        }
        return response()->json('حدث خطأ ما! من فضلك حاول مجددا.', 500);
    }


    /**
     * Show the form for editing the specified resource.
     *
     * @param  \App\Models\Category  $category
     * @return \Illuminate\Http\Response
     */
    public function edit(Category $category)
    {
        return view('admin.categories.edit-category')->with('category', $category);
    }


    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \App\Models\Category  $category
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, Category $category)
    {
        $request->validate([
            'name' => 'required|min:2|max:255',
            'category' => 'nullable|exists:categories,id',
            'image' => 'image|max:8192',
            'icon' => 'required|min:3',
        ]);

        $category->name = $request->name;
        $slug = Str::slug($request->name);
        $category->slug = Category::where('slug', $slug)->where('id', '!=', $category->id)->count() ? $slug.'-'.uniqid() : $slug;
        $category->icon = $request->icon;
        $category->category_id = $request->category != $category->id ? $request->category : null;

        if($category->save()){
            $category->upload_category_image($request->file('image'));
            $category->update_tree();
            return redirect()->route('categories')->with('success', 'تم تعديل البيانات بنجاح.');
        }
        return redirect()->back()->with('failure', 'حدث خطأ ما! من فضلك حاول مجددا.');
    }


    /**
     * Remove the specified resource from storage.
     *
     * @param  \App\Models\Category  $category
     * @return \Illuminate\Http\Response
     */
    public function destroy(Category $category)
    {
        if( $category->delete() )
            return response()->json('تم الحذف بنجاح.', 200);
        return response()->json('حدث خطأ ما! من فضلك حاول مجددا!', 500);
    }

    public function delete_category_image(Category $category){
        return $category->delete_file('image');
    }

    public function sub_categories(Category $category){
        $sub_categories = array();
        foreach ($category->all_children() as $child) {
            $prefix = '';
            for ($i=2; $i < $child->level(); $i++) { $prefix .= '___'; }
            $sub_categories[$child->slug] = $prefix .' '. $child->name;
        }
        return json_encode($sub_categories);
    }
}
